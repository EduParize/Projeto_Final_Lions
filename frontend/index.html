<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmeiras History & Squad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Cores do Verd√£o */
        :root { --palmeiras-green: #006437; --palmeiras-dark: #004626; }
        body { background-color: #f4f4f4; }
        
        .header-app { background-color: var(--palmeiras-green); color: white; padding: 15px; }
        .nav-pills .nav-link.active { background-color: var(--palmeiras-dark) !important; }
        .nav-pills .nav-link { color: var(--palmeiras-green); font-weight: bold; }

        /* Estilo da Hist√≥ria */
        .year-card { border-left: 5px solid var(--palmeiras-green); transition: transform 0.2s; }
        .year-card:hover { transform: translateX(5px); }
        .shirt-img { height: 100px; object-fit: contain; }

        /* Estilo do Campinho (Escala√ß√£o) */
        .field-container {
            background: linear-gradient(0deg, #2e7d32 0%, #388e3c 50%, #2e7d32 100%);
            border: 5px solid white;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        /* Linhas do campo */
        .field-line { border-top: 2px solid rgba(255,255,255,0.3); width: 100%; position: absolute; top: 50%; }
        .center-circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .player-slot {
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            z-index: 10;
        }
        .player-slot:hover { transform: scale(1.1); }
        .slot-circle {
            width: 60px; height: 60px;
            background-color: white;
            border-radius: 50%;
            margin: 0 auto;
            display: flex; justify-content: center; align-items: center;
            border: 3px solid var(--palmeiras-green);
            font-size: 1.5rem; color: #ccc; overflow: hidden;
        }
        .player-name {
            background-color: rgba(0,0,0,0.7); color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px;
        }
        .slot-filled img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div class="header-app d-flex justify-content-between align-items-center shadow">
        <div class="d-flex align-items-center gap-2">
            <span style="font-size: 1.5rem;">üê∑</span>
            <div>
                <h5 class="m-0 fw-bold">Verd√£o Info</h5>
                <small id="user-display">Bem-vindo</small>
            </div>
        </div>
        <button onclick="logout()" class="btn btn-outline-light btn-sm">Sair</button>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-history">üèÜ Hist√≥ria</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-squad" onclick="carregarJogadoresDisponiveis()">‚öΩ Montar Time</button>
            </li>
            <li class="nav-item" id="admin-tab-li" style="display: none;">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-admin">‚öôÔ∏è Admin</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="tab-history">
                <h3 class="text-center text-secondary mb-4">Linha do Tempo Alviverde</h3>
                <div id="history-container">
                    </div>
            </div>

            <div class="tab-pane fade" id="tab-squad">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5>Como funciona?</h5>
                                <p class="small text-muted">Clique nas posi√ß√µes no campo para escolher um jogador do banco de dados oficial.</p>
                                <button class="btn btn-danger w-100" onclick="limparEscalacao()">Limpar Time</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="field-container shadow-lg" id="soccer-field">
                            <div class="field-line"></div>
                            <div class="center-circle"></div>
                            
                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 0)">
                                    <div class="slot-circle" id="slot-0">?</div>
                                    <div class="player-name" id="name-0">Atacante</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 1)">
                                    <div class="slot-circle" id="slot-1">?</div>
                                    <div class="player-name" id="name-1">Atacante</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 2)">
                                    <div class="slot-circle" id="slot-2">?</div>
                                    <div class="player-name" id="name-2">Atacante</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 3)">
                                    <div class="slot-circle" id="slot-3">?</div>
                                    <div class="player-name" id="name-3">Meia</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 4)">
                                    <div class="slot-circle" id="slot-4">?</div>
                                    <div class="player-name" id="name-4">Meia</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 5)">
                                    <div class="slot-circle" id="slot-5">?</div>
                                    <div class="player-name" id="name-5">Meia</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 6)">
                                    <div class="slot-circle" id="slot-6">?</div>
                                    <div class="player-name" id="name-6">Lateral</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 7)">
                                    <div class="slot-circle" id="slot-7">?</div>
                                    <div class="player-name" id="name-7">Zagueiro</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 8)">
                                    <div class="slot-circle" id="slot-8">?</div>
                                    <div class="player-name" id="name-8">Zagueiro</div>
                                </div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 9)">
                                    <div class="slot-circle" id="slot-9">?</div>
                                    <div class="player-name" id="name-9">Lateral</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-center w-100">
                                <div class="player-slot" onclick="abrirSelecao('Goleiro', 10)">
                                    <div class="slot-circle text-warning" id="slot-10">üß§</div>
                                    <div class="player-name" id="name-10">Goleiro</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-admin">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">‚öôÔ∏è √Årea Administrativa</div>
                    <div class="card-body">
                        <h5>Cadastrar Novo Jogador</h5>
                        <form id="form-admin" class="row g-3">
                            <div class="col-md-6">
                                <input type="text" id="adm-nome" class="form-control" placeholder="Nome Completo" required>
                            </div>
                            <div class="col-md-4">
                                <select id="adm-posicao" class="form-select" required>
                                    <option value="" disabled selected>Posi√ß√£o</option>
                                    <option value="Goleiro">Goleiro</option>
                                    <option value="Defensor">Defensor</option>
                                    <option value="Meio Campo">Meio Campo</option>
                                    <option value="Atacante">Atacante</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-success w-100">Salvar</button>
                            </div>
                        </form>
                        <hr>
                        <h6>Jogadores no Banco de Dados:</h6>
                        <ul id="admin-lista" class="list-group">
                            </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalSelecao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Escolher Jogador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="lista-selecao" class="list-group">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');

        // 1. DADOS MOCADOS DA HIST√ìRIA (Voc√™ pode editar aqui)
        const historyData = [
            {
                year: 2023,
                titles: ["Campeonato Brasileiro", "Supercopa do Brasil", "Campeonato Paulista"],
                summary: "Um ano de consolida√ß√£o da 'Terceira Academia'. Abel Ferreira comandou o time rumo ao Dodeca brasileiro em uma arrancada hist√≥rica.",
                shirt1: "https://via.placeholder.com/100?text=Camisa+1", // Troque por link real da imagem
                shirt2: "https://via.placeholder.com/100?text=Camisa+2"
            },
            {
                year: 2022,
                titles: ["Campeonato Brasileiro", "Recopa Sul-Americana", "Campeonato Paulista"],
                summary: "O ano do Hendeca! O time foi uma m√°quina, perdendo pouqu√≠ssimos jogos e revelando Endrick para o mundo.",
                shirt1: "https://via.placeholder.com/100?text=Camisa+1",
                shirt2: "https://via.placeholder.com/100?text=Camisa+2"
            },
            {
                year: 2021,
                titles: ["Copa Libertadores (Bi)"],
                summary: "O ano da Gl√≥ria Eterna parte 2. Vencemos o Flamengo em Montevid√©u com o gol hist√≥rico de Deyverson.",
                shirt1: "https://via.placeholder.com/100?text=Camisa+1",
                shirt2: "https://via.placeholder.com/100?text=Camisa+2"
            }
        ];

        // --- INICIALIZA√á√ÉO ---
        
        if (!token) window.location.href = 'login.html';

        document.getElementById('user-display').innerText = `Ol√°, ${user.name}`;

        // Se for ADMIN, mostra a aba Admin
        if (user.role && user.role.includes("ADMIN")) {
            document.getElementById('admin-tab-li').style.display = 'block';
            carregarAdminLista();
        }

        // Renderiza a Hist√≥ria
        const historyContainer = document.getElementById('history-container');
        historyData.forEach(item => {
            const html = `
                <div class="card mb-3 year-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="text-success fw-bold">${item.year}</h2>
                            <div>
                                ${item.titles.map(t => `<span class="badge bg-warning text-dark me-1">üèÜ ${t}</span>`).join('')}
                            </div>
                        </div>
                        <p>${item.summary}</p>
                        <div class="d-flex gap-3 mt-3">
                            <div class="text-center">
                                <small class="d-block fw-bold mb-1">Uniforme I</small>
                                <img src="${item.shirt1}" class="shirt-img rounded bg-light p-1 border">
                            </div>
                            <div class="text-center">
                                <small class="d-block fw-bold mb-1">Uniforme II</small>
                                <img src="${item.shirt2}" class="shirt-img rounded bg-light p-1 border">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            historyContainer.innerHTML += html;
        });

        // --- L√ìGICA DO "MEU TIME" ---

        let slotAtual = null; // Guarda qual bolinha foi clicada (0 a 10)
        let todosJogadores = []; // Guarda a lista vinda da API

        async function carregarJogadoresDisponiveis() {
            try {
                const res = await fetch(`${API_URL}/players`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                todosJogadores = await res.json();
            } catch (err) { console.error(err); }
        }

        function abrirSelecao(posicaoFiltro, slotId) {
            slotAtual = slotId;
            const listaModal = document.getElementById('lista-selecao');
            listaModal.innerHTML = '';

            // Filtra jogadores pela posi√ß√£o clicada
            const disponiveis = todosJogadores.filter(p => p.positionPlayer === posicaoFiltro);

            if (disponiveis.length === 0) {
                listaModal.innerHTML = '<div class="p-3 text-center">Nenhum jogador dessa posi√ß√£o encontrado no banco.</div>';
            }

            disponiveis.forEach(jogador => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action d-flex justify-content-between';
                btn.innerHTML = `<strong>${jogador.namePlayer}</strong> <span class="badge bg-secondary">${jogador.positionPlayer}</span>`;
                btn.onclick = () => selecionarJogador(jogador);
                listaModal.appendChild(btn);
            });

            const modal = new bootstrap.Modal(document.getElementById('modalSelecao'));
            modal.show();
        }

        function selecionarJogador(jogador) {
            // Atualiza visualmente o slot
            document.getElementById(`slot-${slotAtual}`).innerHTML = '‚öΩ'; // Podia ser a foto do jogador
            document.getElementById(`slot-${slotAtual}`).classList.add('bg-success', 'text-white');
            document.getElementById(`name-${slotAtual}`).innerText = jogador.namePlayer;
            
            // Fecha modal
            const modalEl = document.getElementById('modalSelecao');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        function limparEscalacao() {
            for(let i=0; i<=10; i++) {
                document.getElementById(`slot-${i}`).innerHTML = '?';
                document.getElementById(`slot-${i}`).classList.remove('bg-success', 'text-white');
                document.getElementById(`name-${i}`).innerText = i === 10 ? 'Goleiro' : 'Jogador';
            }
        }

        // --- L√ìGICA DE ADMIN ---

        document.getElementById('form-admin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('adm-nome').value;
            const posicao = document.getElementById('adm-posicao').value;

            try {
                const res = await fetch(`${API_URL}/players`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // ADMIN PRECISA DISSO
                    },
                    body: JSON.stringify({ namePlayer: nome, positionPlayer: posicao })
                });

                if (res.ok) {
                    alert('Jogador adicionado!');
                    document.getElementById('form-admin').reset();
                    carregarAdminLista();
                    carregarJogadoresDisponiveis(); // Atualiza a lista pro time
                } else {
                    const data = await res.json();
                    alert('Erro: ' + (data.error || 'Falha'));
                }
            } catch (error) { alert('Erro de conex√£o'); }
        });

        async function carregarAdminLista() {
            const res = await fetch(`${API_URL}/players`);
            const lista = await res.json();
            const ul = document.getElementById('admin-lista');
            ul.innerHTML = '';
            
            lista.forEach(j => {
                ul.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between">
                        ${j.namePlayer} (${j.positionPlayer})
                        <button class="btn btn-sm btn-danger" onclick="removerJogador('${j._id}')">X</button>
                    </li>
                `;
            });
        }

        async function removerJogador(id) {
            if(!confirm('Apagar jogador?')) return;
            await fetch(`${API_URL}/players/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            carregarAdminLista();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>