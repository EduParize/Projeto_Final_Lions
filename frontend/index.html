<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmeiras History & Squad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --palmeiras-green: #006437; --palmeiras-dark: #004626; }
        body { background-color: #f4f4f4; }
        .header-app { background-color: var(--palmeiras-green); color: white; padding: 15px; }
        .nav-pills .nav-link.active { background-color: var(--palmeiras-dark) !important; }
        .nav-pills .nav-link { color: var(--palmeiras-green); font-weight: bold; }
        
        /* Campo */
        .field-container {
            background: linear-gradient(0deg, #2e7d32 0%, #388e3c 50%, #2e7d32 100%);
            border: 5px solid white; border-radius: 10px;
            padding: 20px; position: relative; min-height: 600px;
            display: flex; flex-direction: column; justify-content: space-around;
        }
        .field-line { border-top: 2px solid rgba(255,255,255,0.3); width: 100%; position: absolute; top: 50%; }
        .center-circle { width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .player-slot { text-align: center; cursor: pointer; transition: 0.3s; z-index: 10; }
        .player-slot:hover { transform: scale(1.1); }
        .slot-circle {
            width: 60px; height: 60px; background-color: white; border-radius: 50%;
            margin: 0 auto; display: flex; justify-content: center; align-items: center;
            border: 3px solid var(--palmeiras-green); font-size: 1.5rem; color: #ccc;
        }
        .player-name { background-color: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px; }
        .bg-selected { background-color: #006437 !important; color: white !important; }
    </style>
</head>
<body>

    <div class="header-app d-flex justify-content-between align-items-center shadow">
        <div class="d-flex align-items-center gap-2">
            <span style="font-size: 1.5rem;">üê∑</span>
            <div>
                <h5 class="m-0 fw-bold">Verd√£o Info</h5>
                <small id="user-display">Bem-vindo</small>
            </div>
        </div>
        <button onclick="logout()" class="btn btn-outline-light btn-sm">Sair</button>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-history">üèÜ Hist√≥ria</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-squad" onclick="carregarJogadoresDisponiveis()">‚öΩ Montar Time</button></li>
            <li class="nav-item" id="admin-tab-li" style="display: none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-admin">‚öôÔ∏è Admin</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-history">
                <div id="history-container"></div>
            </div>

            <div class="tab-pane fade" id="tab-squad">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm sticky-top" style="top: 20px;">
                            <div class="card-body">
                                <h5>Seu Elenco</h5>
                                <p class="small text-muted">Monte seu time com os craques da hist√≥ria.</p>
                                <button class="btn btn-success w-100 mb-2" onclick="salvarTime()">üíæ Salvar Time</button>
                                <button class="btn btn-outline-danger w-100" onclick="limparEscalacao()">Limpar</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="field-container shadow-lg">
                            <div class="field-line"></div>
                            <div class="center-circle"></div>
                            
                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 0)"><div class="slot-circle" id="slot-0">?</div><div class="player-name" id="name-0">Atacante</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 1)"><div class="slot-circle" id="slot-1">?</div><div class="player-name" id="name-1">Atacante</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Atacante', 2)"><div class="slot-circle" id="slot-2">?</div><div class="player-name" id="name-2">Atacante</div></div>
                            </div>
                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 3)"><div class="slot-circle" id="slot-3">?</div><div class="player-name" id="name-3">Meia</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 4)"><div class="slot-circle" id="slot-4">?</div><div class="player-name" id="name-4">Meia</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Meio Campo', 5)"><div class="slot-circle" id="slot-5">?</div><div class="player-name" id="name-5">Meia</div></div>
                            </div>
                            <div class="d-flex justify-content-around w-100">
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 6)"><div class="slot-circle" id="slot-6">?</div><div class="player-name" id="name-6">Lateral</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 7)"><div class="slot-circle" id="slot-7">?</div><div class="player-name" id="name-7">Zagueiro</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 8)"><div class="slot-circle" id="slot-8">?</div><div class="player-name" id="name-8">Zagueiro</div></div>
                                <div class="player-slot" onclick="abrirSelecao('Defensor', 9)"><div class="slot-circle" id="slot-9">?</div><div class="player-name" id="name-9">Lateral</div></div>
                            </div>
                            <div class="d-flex justify-content-center w-100">
                                <div class="player-slot" onclick="abrirSelecao('Goleiro', 10)"><div class="slot-circle text-warning" id="slot-10">üß§</div><div class="player-name" id="name-10">Goleiro</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-admin">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">‚öôÔ∏è Admin Area</div>
                    <div class="card-body">
                        <h5>Cadastrar Jogador</h5>
                        <form id="form-admin" class="row g-3">
                            <div class="col-md-6"><input type="text" id="adm-nome" class="form-control" placeholder="Nome" required></div>
                            <div class="col-md-4">
                                <select id="adm-posicao" class="form-select" required>
                                    <option value="" disabled selected>Posi√ß√£o</option>
                                    <option value="Goleiro">Goleiro</option>
                                    <option value="Defensor">Defensor</option>
                                    <option value="Meio Campo">Meio Campo</option>
                                    <option value="Atacante">Atacante</option>
                                </select>
                            </div>
                            <div class="col-md-2"><button type="submit" class="btn btn-success w-100">Salvar</button></div>
                        </form>
                        <hr>
                        <h6>Jogadores Cadastrados:</h6>
                        <ul id="admin-lista" class="list-group"></ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalSelecao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Escolher Jogador</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><div id="lista-selecao" class="list-group"></div></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        // Estado local do time (vetor com 11 posi√ß√µes, guarda o objeto jogador ou null)
        let timeAtual = new Array(11).fill(null);

        if (!token) window.location.href = 'login.html';

        // Inicializa√ß√£o
        document.getElementById('user-display').innerText = `Ol√°, ${user.name}`;
        
        // 1. CHECAGEM DE ROLE (Agora funciona!)
        // O user.role agora vem do backend no login. Pode ser array ["ADMIN", "USER"]
        if (user.role && user.role.includes("ADMIN")) {
            document.getElementById('admin-tab-li').style.display = 'block';
            carregarAdminLista();
        }

        // 2. CARREGAR TIME SALVO
        if (user.myTeam && user.myTeam.length > 0) {
            // Preenche o timeAtual com o que veio do login
            user.myTeam.forEach((jogador, index) => {
                if (index < 11) {
                    timeAtual[index] = jogador;
                    atualizarSlotVisual(index, jogador);
                }
            });
        }

        // --- FUN√á√ïES MEU TIME ---
        let slotFoco = null;
        let todosJogadores = [];

        async function carregarJogadoresDisponiveis() {
            try {
                const res = await fetch(`${API_URL}/players`, { headers: {'Authorization': `Bearer ${token}`} });
                todosJogadores = await res.json();
            } catch (err) { console.error(err); }
        }

        function abrirSelecao(posicao, slotId) {
            slotFoco = slotId;
            const listaDiv = document.getElementById('lista-selecao');
            listaDiv.innerHTML = '';
            
            const filtrados = todosJogadores.filter(p => p.positionPlayer === posicao);
            
            if(filtrados.length === 0) listaDiv.innerHTML = '<div class="p-2">Nenhum jogador encontrado.</div>';

            filtrados.forEach(j => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action';
                btn.innerHTML = `<strong>${j.namePlayer}</strong> <small>(${j.positionPlayer})</small>`;
                btn.onclick = () => escolherJogador(j);
                listaDiv.appendChild(btn);
            });
            new bootstrap.Modal(document.getElementById('modalSelecao')).show();
        }

        function escolherJogador(jogador) {
            timeAtual[slotFoco] = jogador; // Salva na mem√≥ria
            atualizarSlotVisual(slotFoco, jogador); // Mostra na tela
            bootstrap.Modal.getInstance(document.getElementById('modalSelecao')).hide();
        }

        function atualizarSlotVisual(index, jogador) {
            const slot = document.getElementById(`slot-${index}`);
            const name = document.getElementById(`name-${index}`);
            slot.innerText = "‚öΩ"; // Ou imagem se tiver
            slot.classList.add('bg-selected');
            name.innerText = jogador.namePlayer;
        }

        function limparEscalacao() {
            timeAtual.fill(null);
            for(let i=0; i<11; i++) {
                document.getElementById(`slot-${i}`).innerText = i===10?'üß§':'?';
                document.getElementById(`slot-${i}`).classList.remove('bg-selected');
                document.getElementById(`name-${i}`).innerText = i===10?'Goleiro':'Posi√ß√£o';
            }
        }

        async function salvarTime() {
            // Filtra os slots vazios e pega s√≥ os IDs
            const playerIds = timeAtual.filter(p => p !== null).map(p => p._id);

            try {
                const res = await fetch(`${API_URL}/users/team`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ playerIds })
                });

                if (res.ok) {
                    // Atualiza o localStorage para o time persistir se der F5
                    const novoTime = await res.json(); // Backend devolve o time populado
                    user.myTeam = novoTime;
                    localStorage.setItem('user', JSON.stringify(user));
                    alert('Time salvo com sucesso! üê∑');
                } else {
                    alert('Erro ao salvar time.');
                }
            } catch (error) { console.error(error); alert('Erro de conex√£o'); }
        }

        // --- ADMIN & HIST√ìRIA (Mantidos iguais) ---
        const historyData = [
            { year: 2023, titles: ["Brasileir√£o", "Paulista", "Supercopa"], summary: "O ano do Dodeca!", shirt1: "img/2023_1.png", shirt2: "img/2023_2.png" },
            { year: 2021, titles: ["Libertadores"], summary: "Gl√≥ria Eterna Tricampe√£!", shirt1: "img/2021_1.png", shirt2: "img/2021_2.png" }
        ]; // Adicione mais anos aqui
        
        const histContainer = document.getElementById('history-container');
        historyData.forEach(h => {
            histContainer.innerHTML += `
                <div class="card mb-3 shadow-sm border-success border-start border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h3 class="text-success fw-bold">${h.year}</h3>
                            <div>${h.titles.map(t=>`<span class="badge bg-warning text-dark me-1">üèÜ ${t}</span>`).join('')}</div>
                        </div>
                        <p>${h.summary}</p>
                    </div>
                </div>`;
        });

        // Admin Logic
        document.getElementById('form-admin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('adm-nome').value;
            const posicao = document.getElementById('adm-posicao').value;
            try {
                const res = await fetch(`${API_URL}/players`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ namePlayer: nome, positionPlayer: posicao })
                });
                if(res.ok) { alert('Cadastrado!'); document.getElementById('form-admin').reset(); carregarAdminLista(); }
            } catch(e) { alert('Erro'); }
        });

        async function carregarAdminLista() {
            const res = await fetch(`${API_URL}/players`);
            const lista = await res.json();
            const ul = document.getElementById('admin-lista');
            ul.innerHTML = '';
            lista.forEach(j => {
                ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">${j.namePlayer} (${j.positionPlayer}) <button class="btn btn-sm btn-danger" onclick="delPlayer('${j._id}')">X</button></li>`;
            });
        }
        async function delPlayer(id) {
            if(confirm('Apagar?')) {
                await fetch(`${API_URL}/players/${id}`, { method: 'DELETE', headers: {'Authorization':`Bearer ${token}`} });
                carregarAdminLista();
            }
        }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>